<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>sunder admin</title>
    <style>
        @font-face {
            font-family: 'numbrs';
            src: url(numbrs.ttf) format('truetype');
        }
        body {
            background-color: rgb(22, 22, 22);
            color: aliceblue;
            text-align: center;
        }
        #title {
            font-family: '1', sans-serif;
            color: red;
        }
        video {
            width: 100%;
            height: 400px;
        }
        #code-custom {
            width: 80%;
            height: 40px;
            border-radius: 20px;
            border: none;
            margin-top: 30px;
            outline-color: blue;
            background-color: rgb(12,12,12);
            text-align: center;
            color: aliceblue;
            font-size: 30px;
            font-family: 'numbrs', sans-serif;
        }
        #set-code {
            overflow: hidden;
            height: 60px;
            width: 100px;
            border-radius: 40px;
            background-color: rgb(12,12,12);
            margin-top: 30px;
        }
        #hcode {
            font-family: '1', sans-serif;
            color: blue;
        }
    </style>
</head>
<body>
    <h1 id="title">islam DZL</h1>
    <video id="video" controls autoplay></video>
    <div style="display: inline-block">
        <input type="text" id="code-custom">
        <button id="set-code"><h3 id="hcode">Set Code</h3></button>
    </div>

    <script>
    const webSocketUrl = "wss://sounder.onrender.com"; // ws://192.168.178.90:2007 wss://sounder.onrender.com
    let sourceBuffer;
    let mediaSource;
    const video = document.getElementById('video');
    const setCodeButton = document.getElementById('set-code');
    const codeCustomInput = document.getElementById('code-custom');
    let socket;

    function setupWebSocket() {
        socket = new WebSocket(webSocketUrl);

        socket.onopen = () => {
            alert('Connection established with the WebSocket Server!');
            mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);
            mediaSource.addEventListener('sourceopen', () => {
                sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs=vp8,opus');
                sourceBuffer.mode = 'sequence';
            });
        };

        socket.onmessage = async (event) => {
            try {
                console.log('Message received');
                const data = JSON.parse(event.data);
                if (data && data.strem) {
                    const videoBlob = new Blob([data.strem], { type: 'video/webm' });
                    const arrayBuffer = await videoBlob.arrayBuffer();

                    if (sourceBuffer && mediaSource.readyState === 'open') {
                        sourceBuffer.appendBuffer(arrayBuffer);
                    } else {
                        console.error('MediaSource is not open or SourceBuffer is not available');
                    }
                }
            } catch (error) {
                console.error('Error appending buffer:', error);
            }
        };

        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        socket.onclose = () => {
            console.log('WebSocket connection closed, retrying...');
            setTimeout(setupWebSocket, 1000); // إعادة محاولة الاتصال بعد 1 ثانية
        };
    }

    setCodeButton.addEventListener('click', () => {
        const key = codeCustomInput.value;
        if (key) {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ set_key: key }));
            } else {
                alert('WebSocket connection is not open. Please try again later.');
            }
        } else {
            alert('Please enter a code.');
        }
    });

    setupWebSocket();
    </script>
</body>
</html>
